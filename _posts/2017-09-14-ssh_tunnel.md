---
layout: post
title: ssh隧道技术 
tags:
-  端口转发
- 
categories: 
description: 
---
### ssh隧道
ssh通常用于加密的远程登陆,其他ssh功能非常强大,其中一个就是端口转发,也叫 隧道 `tunnel` , 能封装一些没有加密功能的tcp协议 telnet ,smtp 等  让这些不安全的协议的数据包由ssh 加密后安全传输, 而且能通过跳板机穿透防火墙的限制等.

<!-- more -->

### ssh 端口转发实例

#### 场景一:

![本地转发](http://47.91.157.219/ssh/ssh.png)

+ 公司内有两台服务器 `172.18.0.10`  `172.18.0.11`  两台机器都是内网机器,相互之间可以通信
+ `172.18.0.10` 这台机器由两个IP 里一个是公网地址 `61.160.21.3` 可以与互联网通信,而且防火墙只允许这台机器ssh的22端口通过.
+ `192.168.0.25` 是公司的一个出差员工, 想要访问 公司内网中 `172.18.0.11` 服务器.  但他只能远程 `61.160.21.3` 到这台主机上.

在这样的情况下就可利用ssh的隧道功能访问

> 员工如果是linux系统可以运行以下命令

```shell
ssh -L 1080:172.18.0.11:80  61.160.21.3
```

分析 : `-L`  : local表示本地转发 ,如图所示 客户端自己开个端口 `1080` 监听自己ip的 1080 端口 , 所有通过这个 端口的数据包,都会由 客户端和`61.160.21.3` 连接的ssh 加密后安全送到 `61.160.21.3` 

`172.18.0.11:80` 这台服务器解密后发现里面是个 `172.18.0.11:80` ,就去找这台服务器, 响应后原路返回

注意 : 运行这条命令后,客户端会ssh登陆到    `61.160.21.3`  服务器上 ,此时隧道已经搭建好 , 浏览器中输入 

`http://127.0.0.1:1080` 相当于间接访问  `http://172.18.0.11:80` 

> windous服务器可以利用xhell来搭建隧道

搭建方式:
选择远程主机ip地址

![本地转发](http://47.91.157.219/ssh/ssh2.png)

点击隧道 ---> 添加--->选择类型--->源主机--->目标主机--->目标端口

![本地转发](http://47.91.157.219/ssh/ssh3.png)

然后连接登陆上去就可以了,这样的就叫本地转发

#### 场景二 :

![远程转发](http://47.91.157.219/ssh/ssh4.png)

如图如果在公司里``想访问家里电脑的资源,而且有一台公司的服务器,就可以使用远程转发的方式前提条件

+ 你对服务器`103.27.14.2` 由管理权限,能控制监听的端口
+ ssh命令需要在被访问的的机器上运行,例如: 公司内网机器访问家庭的,需要在家庭机器上开隧道
+ 被访问的机器需要开发端口,一般pc机防火墙会默认阻止外来的主动连接

> 如果家庭内网机器 `192.18.31.2` 是linux主机 可以运行

```shell
ssh -R 1080:192.18.31.2:80 103.27.14.2
```

`-R` :表示开启远程转发, `192.18.31.2` 与 `103.27.14.2` 建立ssh 隧道后,相当与 `103.27.14.2` 这个有公网地址的服务器帮你监听 `1080` 端口, 并把通过这个端口的所有连接 转成 访问`192.18.31.2:80`的请求公司内网中的机器就可以利用 `http://103.27.14.2:1080 ` 的url 访问家庭内网中的主机 .

这种方式有点类似与 在路由器上做端口映射,但是一般家庭的路由ip地址是动态获取,不是固定的.还要用申请动态域名的东西, 非常麻烦,linux一条命令搞定


> 如果windons可以用xshell做隧道如下方式

选择远程主机地址,和本地端口转发一样

![远程转发](http://47.91.157.219/ssh/ssh5.png)

#### 场景三:

有墙的地方

我们可以利用 ssh + sock5 的方式,穿透防火墙 , sock5 是一种动态代理技术,

ssh使用代理的命令为

```shell
ssh -D 1080 <remote_host>      # <remote_host> 表示任意一台墙外的服务器主机
```

前提条件:

+ 你要有一台墙外的服务器并且能有个能ssh上去的普通用户

windous使用xhell 翻越防火墙实例:

选择类型为动态隧道

![动态转发](http://47.91.157.219/ssh/ssh6.png)

远程上去后配置浏览器代理 firefox为例:

依次选择  菜单--->选项--->高级--->网络--->设置
![动态转发](http://47.91.157.219/ssh/ssh7.png)

设置中选择监听本地的 `1080` 端口, 可以自己定义,与xhell中保持一致即可

![动态转发](http://47.91.157.219/ssh/ssh8.png)

xshell连接成功后,点击 查看-->隧道窗格-->转义规则, 即可查看隧道连接情况,绿色小点表示成功

![动态转发](http://47.91.157.219/ssh/ssh9.png)

之后就可以访问你想要的网站


![动态转发](http://47.91.157.219/ssh/ssh10.png)

